<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>WordPress 4.1.2 / 4.2.1 XSS Vulnerability - Linux.im</title>
    <meta name="description" content="Hacking for fun. - evi1m0"/>
    <link rel="stylesheet" href="/css/linux-im.css" type="text/css" />
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" />
  </head>
  <body>
    <style>
      h1 {
        font-family: STFangSong, Helvetica, Arial, Vernada, Tahoma, STXihei, "Microsoft YaHei", "Songti SC", SimSun, Heiti, sans-serif;
      }
    </style>
    <div class="site">
      <div class="post-content" style="margin-top: -20px;">
        <div id="post">
          <h1 id="wordpress-412--421-xss-vulnerability">WordPress 4.1.2 / 4.2.1 XSS Vulnerability</h1>
<p class="date">28 Apr 2015 - evi1m0</p>

<p>è¿™ä¸¤ä¸ªæ¼æ´ç›¸ç»§åœ¨ cedricvb å’Œ fd æŠ¥å‘Šå‡ºæ¥åä¼¼ä¹å¹¶æ²¡æœ‰å¼•èµ·å¹¿æ³›çš„å…³å¿ƒï¼Œå¹³é™äº†ä¸¤å¤©åå›½å†…å„å…¬å¸åª’ä½“æ‰å¼€å§‹å®£ä¼ çˆ†æ¼æ´äº†ï¼Œçˆ†æ¼æ´äº†ï¼ŒåŸå› å¯èƒ½ç”±äºä»æµ·å¤–æ¼‚è¿‡æ¥éœ€è¦ç‚¹å„¿æ—¶é—´ï¼Œå¦å¤–ä¸å°‘å®‰å…¨ç ”ç©¶äººå‘˜è§‰å¾—åˆ©ç”¨èµ·æ¥é¸¡è‚‹ï¼Œå…¶å®è¿˜æ˜¯å¾ˆå¥½åˆ©ç”¨çš„ã€‚æˆ‘èŠ±è´¹äº†å¤§å¥½ç¡çœ æ—¶å…‰æå®šäº†å®Œç¾çš„æ”»å‡»è½½è·ï¼Œæ‰€ä»¥æ–‡ç« åªè¿›è¡Œç®€å•çš„åˆ†æå’Œè¯´ä¸‹å¤§è‡´æ€è·¯ï¼Œä¸å¼€æ”¾æœ€ç»ˆæ”»å‡»ä»£ç ã€‚</p>

<h5 id="wordpress-database-schema">WordPress Database Schema:</h5>

<center><img src="http://ww3.sinaimg.cn/large/c334041bjw1erlolkehbtj20o90xudmc.jpg" /></center>

<h5 id="wordpress-412-stored-xss">WordPress &lt;4.1.2 Stored XSS:</h5>

<ul>
  <li>Vul: <a href="https://cedricvb.be/post/wordpress-stored-xss-vulnerability-4-1-2/">https://cedricvb.be/post/wordpress-stored-xss-vulnerability-4-1-2/</a></li>
  <li>Fix: <a href="https://wordpress.org/news/2015/04/wordpress-4-1-2/">https://wordpress.org/news/2015/04/wordpress-4-1-2/</a></li>
</ul>

<p>å…³äºè¿™ä¸¤ä¸ªè·¨ç«™æ¼æ´éƒ½æ¯”è¾ƒæœ‰è¶£ï¼Œ&lt;4.1.2 XSS æ˜¯ç”±äº WordPress ä½¿ç”¨äº† utf8mb4 ï¼Œä½†æ˜¯ MySQL é»˜è®¤é…ç½®ä¸º utf8 ã€‚ï¼ˆå…¶ä¸­å¯¹ utf8mb4 å­—ç¬¦é›†çš„æ”¯æŒæ˜¯ MySQL 5.5 çš„æ–°åŠŸèƒ½ï¼Œæ”¯æŒäº†å­˜å‚¨4å­—èŠ‚çš„ emoji è¡¨æƒ…ã€‚ï¼‰æ‰€ä»¥å½“æˆ‘ä»¬å°†4å­—èŠ‚å­—ç¬¦æ’å…¥æ•°æ®åº“ä¸­æ—¶ï¼Œä¼šè¢« MySQL è‡ªåŠ¨è®¤å®šæ˜¯ utf8mb4 ç¼–ç ï¼Œå› ä¸ºæ•°æ®åº“é»˜è®¤ä¸º MySQL utf8ï¼Œæ‰€ä»¥åœ¨æ•°æ®å­˜å‚¨æ—¶ï¼ˆMySQL éstrict modeï¼‰ä¼šé€ æˆæˆªæ–­ã€‚</p>

<p>ä¸å¾—ä¸è¯´ WordPress è¿™æ¬¡çœŸæ˜¯å¯çˆ±åˆ°å‚»ç“œï¼Œå½“æˆ‘ä»¬å°†æ ‡ç­¾æˆªæ–­é—­åˆåï¼ŒWP æ ‡ç­¾çš„å¼•å·è¢«è½¬ä¹‰ï¼Œå¯¼è‡´äº†æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰æ ‡ç­¾å±æ€§ï¼ŒWordPress é»˜è®¤è¯„è®ºç•™è¨€ç‰ˆæ”¯æŒï¼š</p>

<pre><code> &lt;a href="" title=""&gt;&lt;abbr title=""&gt; &lt;acronym title=""&gt;
 &lt;b&gt; &lt;blockquote cite=""&gt; &lt;cite&gt; &lt;code&gt; &lt;del datetime=""&gt;
 &lt;em&gt; &lt;i&gt; &lt;q cite=""&gt; &lt;strike&gt; &lt;strong&gt;
</code></pre>

<p>è¿™äº›æ ‡ç­¾è¶³å¤Ÿè®©æˆ‘ä»¬å®Œæˆ XSS æ”»å‡»äº†ï¼Œä¾‹å¦‚æˆ‘ä»¬æ’å…¥ï¼š</p>

<pre><code>&lt;abbr title="test onmouseover=alert(1)// ğŒ†"&gt;evi1m0
</code></pre>

<p>HTML ä¼šè¢«è§£æä¸ºï¼š</p>

<pre><code>&lt;abbr title=&amp;#8221;test onmouseover=alert(1)// &lt;/p&gt;
</code></pre>

<p>æµè§ˆå™¨ï¼š</p>

<pre><code>&lt;abbr title="â€test" onmouseover="alert(1)//" &lt;="" p=""&gt;
                            &lt;/abbr&gt;
</code></pre>

<p>å¯¼è‡´æˆ‘ä»¬æˆåŠŸçš„æ’å…¥äº†ä¸€æ¡å¸¦æœ‰ on äº‹ä»¶çš„æ ‡ç­¾è¿›å»ï¼Œä¹‹åä¼šè°ˆä¸€ä¸‹ä¸ºä»€ä¹ˆè¿™æ®µ Payload åœ¨ä¸åŒçš„ WordPress é‡Œé¢ä¼šå¯¼è‡´æœ‰ä¸€å®šå‡ ç‡è§¦å‘ï¼Œæœ‰ä¸€å®šå‡ ç‡å¤±æ•ˆã€‚</p>

<h5 id="wordpress-421-stored-xss">WordPress &lt;4.2.1 Stored XSS:</h5>

<ul>
  <li>Vul: <a href="http://seclists.org/fulldisclosure/2015/Apr/84">http://seclists.org/fulldisclosure/2015/Apr/84</a></li>
  <li>Fix: <a href="https://wordpress.org/news/2015/04/wordpress-4-2-1/">https://wordpress.org/news/2015/04/wordpress-4-2-1/</a></li>
</ul>

<p>ç¬¬äºŒä¸ª &lt;4.2.1 ç‰ˆæœ¬çš„è·¨ç«™æ¼æ´åˆ™æ˜¯ç»§ç»­åˆ©ç”¨ MySQL çš„ç‰¹æ€§æ¥å®Œæˆæ”»å‡»çš„ï¼Œæ ¹æ®æ–‡ç« å¼€å§‹æ—¶çš„ WordPress Database Schema å›¾å¯ä»¥çœ‹åˆ°ï¼Œwp_comments â€“&gt; comment_content å­—æ®µå­˜å‚¨æ ¼å¼ä¸º TEXT ï¼ŒMySQL çš„ TEXT ç±»å‹æœ€å¤§ä¸Šé™ä¸º 65535 å­—èŠ‚ï¼Œæ‰€ä»¥å½“å­˜å‚¨å€¼è¶…è¿‡ 65535 å­—èŠ‚æ—¶ä¼šå¯¹åé¢è¿›è¡Œæˆªæ–­æ“ä½œï¼Œå¯çˆ±çš„ WP å¹¶æœªå¯¹è¯„è®ºå­—æ•°è¿›è¡Œé™åˆ¶å¯¼è‡´æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™æ ·ä¸€æ¡ Payload æ’å…¥æ¶æ„æ ‡ç­¾äº‹ä»¶ï¼š</p>

<pre><code>&lt;a href='x onclick=alert(1) AAAAAAAA...(&lt;64k bytes)'&gt;Evi1m0&lt;/a&gt;
</code></pre>

<p>è§£æåçš„æ•°æ®çœ‹èµ·æ¥åƒè¿™æ ·ï¼š</p>

<pre><code>&lt;p&gt;&lt;a href='x onclick=alert(1) AAAAAAA...&lt;/p&gt;
</code></pre>

<blockquote>
  <p>æ’æ›²ï¼š åœ¨ 64k XSS å®˜æ–¹ä¿®å¤åï¼Œæœ‰è¶£çš„æ˜¯ TSRC ç»•è¿‡äº†å®˜æ–¹è¡¥ä¸ã€‚</p>
</blockquote>

<h5 id="fix">FIX</h5>

<ul>
  <li><a href="https://wordpress.org/news/2015/04/wordpress-4-1-2/">https://wordpress.org/news/2015/04/wordpress-4-1-2/</a></li>
  <li><a href="https://wordpress.org/news/2015/04/wordpress-4-2-1/">https://wordpress.org/news/2015/04/wordpress-4-2-1/</a></li>
</ul>

<h5 id="end">END</h5>

<p>WordPress ä¼šå¯¹ä»æœªè¯„è®ºè¿‡çš„ç”¨æˆ·ç¬¬ä¸€æ¡è¿›è¡Œè¯„è®ºå®¡æ ¸æ“ä½œï¼Œç»è¿‡å®¡æ ¸åä¹‹åçš„è¯„è®ºå°±ä¸éœ€è¦å†æ¬¡ç»è¿‡å®¡æ ¸ï¼Œè¿™ä¹Ÿæ˜¯å¾ˆå¤šäººè¯´ç¨æœ‰é¸¡è‚‹çš„åœ°æ–¹ï¼Œå…¶å®ä»”ç»†æƒ³æƒ³è¿™ä¸æ˜¯é—®é¢˜ã€‚ =)</p>

<p>ä¸¤ä¸ªæç®€ç‰ˆ PoC ï¼š</p>

<ul>
  <li><a href="http://www.beebeeto.com/pdb/poc-2015-0092/">http://www.beebeeto.com/pdb/poc-2015-0092/</a></li>
  <li><a href="http://www.beebeeto.com/pdb/poc-2015-0093/">http://www.beebeeto.com/pdb/poc-2015-0093/</a></li>
</ul>

<p>æœ‰å…³ä¸Šé¢å‡ ä¸ªç®€çŸ­çš„ Payload åœ¨æµ‹è¯•æ—¶æˆ‘å‘ç°ä¸åŒ WordPress ä¸‹æœ‰äº›ä¸èƒ½è§¦å‘ï¼ŒåŸå› æ˜¯ä¸åŒçš„ç¨‹åºæ¨¡æ¿å¯¹è¯„è®ºæ ‡ç­¾çš„ CSS æ ·å¼ä¸åŒï¼Œå¯¼è‡´å¾ˆå¤šæƒ…å†µä¸‹æˆ‘ä»¬æ˜¯æ— æ³•è§¦ç¢°åˆ°è¯„è®ºå†…å®¹åŒºåŸŸçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰ CSS æ ·å¼å®Œæˆè¿™ä¸ªæ“ä½œï¼Œä¾‹å¦‚ï¼š</p>

<pre><code>style='position:fixed;top:0;left:0;width:100%;height:100%'
</code></pre>

<p>å½“ç„¶ä¸Šé¢è¿™ä¸ªå¹¶ä¸æ˜¯å®Œç¾çš„ CSS å…¼å®¹æ ·å¼ï¼Œå¦‚æœä½ æƒ³é€šæ€æ‰€æœ‰æµè§ˆå™¨çš„è¯è¿˜éœ€è¦è‡ªå·±ç®€å•çš„ä¿®æ”¹ä¸€ä¸‹ã€‚</p>

<p>å¦å¤– phithon åœ¨åšå®¢ä¸­ç»™å‡ºä½¿ç”¨ tabindex onfocus è¿™ç§æ–¹æ³•æ¥è¿›è¡Œç›´æ¥è§¦å‘äº‹ä»¶ï¼Œè¿™ç§æ–¹æ³•åœ¨ 13 å¹´åº•æœ‰è¿‡å‡ æ¬¡ç»å…¸æ¡ˆä¾‹åŠ CTF é¢˜ç›®ï¼ŒåŸç†ï¼šåœ¨ä»»æ„æ ‡ç­¾ä¸ŠåŠ tabindexå³å¯è®©è¿™ä¸ªæ ‡ç­¾å¯ä»¥è¢«TABé€‰ä¸­ï¼Œäºæ˜¯å°±æœ‰äº†onfocusäº‹ä»¶ã€‚ç„¶åç”¨ç±»ä¼¼äºé”šçš„æ–¹å¼æ¥æ›¿ä»£æŒ‰é”®TABï¼Œè®¿é—®#idï¼ˆä»¥ä¸Špayloadä¸­id=aï¼Œæ‰€ä»¥æ˜¯#aï¼‰å³å¯è§¦å‘ï¼›</p>

<blockquote>
  <p>tabindex è¿™ç§æ–¹æ³•éœ€è¦åœ¨è¯„è®ºé¡µé¢é“¾æ¥åé¢åŠ å…¥æç‚¹ä»¥è¾¾åˆ°è§¦å‘çš„ç›®çš„ï¼Œå¯èƒ½åœ¨å®æˆ˜ä¸­éœ€è¦é…åˆäº›ç¤¾å·¥æˆåˆ†ã€‚</p>
</blockquote>

<pre><code>&lt;abbr title="aassx id=a tabindex=0 onfocus=alert(1)//
</code></pre>

<p>ç”±äº WordPress ä½¿ç”¨å¹¿æ³›å†å²ä¹…è¿œï¼Œå¯¼è‡´æˆ‘æ²¡æƒ³åˆ°è¿™ç§ç®€å• Fuzz å°±å¯èƒ½ä¼šå‘ç°çš„å®‰å…¨é—®é¢˜ä¼šåœ¨å®ƒèº«ä¸Šå‡ºç°ï¼Œæ·±æ„Ÿæƒ­æ„§ã€‚</p>

        </div>
      </div>

      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_shortname = 'evi1m0';
        (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

      <!-- footer -->
      <div class="footer">
        <div class="contact">
          <p>
            <a href="/" style="text-decoration: none; margin-right: 5px;">Index</a> |&nbsp;
            <a href="/feed.xml" target="_blank" style="text-decoration: none; margin-right: 5px;">RSS</a> |&nbsp;
            <a href="http://weibo.com/Evi1m0" target="_blank" style="text-decoration: none; margin-right: 5px;">Weibo</a> |&nbsp;
            <a href="mailto:evi1m0.bat@gmail.com">evi1m0.bat@gmail.com</a>
          </p>
        </div>
      </div>
    </div>

    <div style="display: none;">
      <script src="http://s4.cnzz.com/z_stat.php?id=1254574847&web_id=1254574847" language="JavaScript"></script>
    </div>
  </body>
</html>
