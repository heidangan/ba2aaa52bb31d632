<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>Django logout function Denial-of-service - Linux.im</title>
    <meta name="description" content="Hacking for fun. - evi1m0"/>
    <link rel="stylesheet" href="/css/linux-im.css" type="text/css" />
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" />
  </head>
  <body>
    <style>
      h1 {
        font-family: STFangSong, Helvetica, Arial, Vernada, Tahoma, STXihei, "Microsoft YaHei", "Songti SC", SimSun, Heiti, sans-serif;
      }
    </style>
    <div class="site">
      <div class="post-content" style="margin-top: -20px;">
        <div id="post">
          <h1 id="django-logout-function-denial-of-service">Django logout function Denial-of-service</h1>
<p class="date">26 Aug 2015 - evi1m0</p>

<ul>
  <li><a href="https://www.djangoproject.com/weblog/2015/aug/18/security-releases/">Security releases issued: 1.8.4, 1.7.10, 1.4.22</a></li>
  <li>CVE: 2015-5963</li>
  <li>Fix: Update/1.8.4/1.7.10/1.4.22/Add @login_required()</li>
</ul>

<p>Django 官方在八月十八号发布多个版本更新，修复几个安全问题，其中便包括一个由编码不当导致的 DoS 漏洞，测试一些网站均存在此问题。</p>

<h5 id="detail">Detail</h5>

<p><code>django.contrib.auth.views.logout</code> 视图用于开发者实现用户注销退出功能，正常情况下对于 logout 视图应使用官方提供的 <code>django.contrib.auth.decorators.login_required</code> 修饰器方法来判断用户是否已经登录。由于不少开发人员忽略使用修饰器进行判断，导致攻击者可以匿名访问视图，不断创建会话阻塞导致拒绝服务攻击。</p>

<p>django/contrib/sessions/middleware.py:</p>

<pre><code>    try:
        accessed = request.session.accessed
        modified = request.session.modified
    except AttributeError:
        pass
    else:
        if accessed:
            patch_vary_headers(response, ('Cookie',))
        if modified or settings.SESSION_SAVE_EVERY_REQUEST:
            if request.session.get_expire_at_browser_close():
                max_age = None
                expires = None
            else:
                max_age = request.session.get_expiry_age()
                expires_time = time.time() + max_age
                expires = cookie_date(expires_time)
            # Save the session data and refresh the client cookie.
            # Skip session save for 500 responses, refs #3881.
            if response.status_code != 500:
                request.session.save()
                response.set_cookie(.....
</code></pre>

<p>在对 settings.SESSION_SAVE_EVERY_REQUEST 的判断条件中，middleware 中间件未对 session 的状态进行判断，导致可能绕过进入判断体创建空会话。</p>

<p><img src="http://ww2.sinaimg.cn/large/c334041bgw1evg3rysahaj20h40bajv7.jpg" alt="http://ww2.sinaimg.cn/large/c334041bgw1evg3rysahaj20h40bajv7.jpg" /></p>

<p>这意味着我们能够发送大量的请求对目标网站进行会话阻塞从而达到拒绝服务攻击：</p>

<p><img src="http://ww1.sinaimg.cn/large/c334041bgw1evg3xircexj20i2036aab.jpg" alt="http://ww1.sinaimg.cn/large/c334041bgw1evg3xircexj20i2036aab.jpg" /></p>

<h5 id="fix">Fix</h5>

<p>django/contrib/sessions/middleware.py:</p>

<pre><code>    try:
        accessed = request.session.accessed
        modified = request.session.modified
        empty = request.session.is_empty()
    except AttributeError:
        pass
    else:
        # First check if we need to delete this cookie.
        # The session should be deleted only if the session is entirely empty
        if settings.SESSION_COOKIE_NAME in request.COOKIES and empty:
            response.delete_cookie(settings.SESSION_COOKIE_NAME,
                domain=settings.SESSION_COOKIE_DOMAIN)
        else:
            if accessed:
                patch_vary_headers(response, ('Cookie',))
            if (modified or settings.SESSION_SAVE_EVERY_REQUEST) and not empty:
</code></pre>

<p>sessions/backends/base.py &amp; sessions/backends/cached_db.py:</p>

<pre><code>def is_empty(self):
    "Returns True when there is no session_key and the session is empty"
    try:
        return not bool(self._session_key) and not self._session_cache
    except AttributeError:
        return True
        
def flush(self):
    """
    Removes the current session data from the database and regenerates the
    key.
    """
    self.clear()
    self.delete()
    self._session_key = None
</code></pre>

<p>虽然严格意义上来讲它是个 DoS 漏洞，但另一方面它完全是由开发者不严谨导致的问题（官方背锅），修复版本将 flush() 的 create() 方法修改以避免创建新的空会话，增加 is_empty() 以用来进行会话判断。</p>

<p>如果你实在不想升级版本，那么记得在必要的视图层增加 @login_required(‘/’) 修饰器。</p>

        </div>
      </div>

      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_shortname = 'evi1m0';
        (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

      <!-- footer -->
      <div class="footer">
        <div class="contact">
          <p>
            <a href="/" style="text-decoration: none; margin-right: 5px;">Index</a> |&nbsp;
            <a href="/feed.xml" target="_blank" style="text-decoration: none; margin-right: 5px;">RSS</a> |&nbsp;
            <a href="http://weibo.com/Evi1m0" target="_blank" style="text-decoration: none; margin-right: 5px;">Weibo</a> |&nbsp;
            <a href="mailto:evi1m0.bat@gmail.com">evi1m0.bat@gmail.com</a>
          </p>
        </div>
      </div>
    </div>

    <div style="display: none;">
      <script src="http://s4.cnzz.com/z_stat.php?id=1254574847&web_id=1254574847" language="JavaScript"></script>
    </div>
  </body>
</html>
